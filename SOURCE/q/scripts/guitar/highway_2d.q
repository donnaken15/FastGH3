highway_lines = 1152
real_highway_lines = 1024
gHighwayStartFade = 800.0
gHighwayEndFade = 1000.0

script Set2DHighwaySpeed\{speed = -1.0}
	Change StructureName = <player_status> highway_speed = <speed>
	SetScreenElementProps id = <id> MaterialProps = [
		{name = m_velocityV property = <speed>}
		{name = m_tiling property = ($gHighwayTiling)}
	]
endscript

gem_time_table512 = []
rowHeightNormalizedDistance = []
rowHeight = []
time_accum_table = []
heightPerspFact = 1.0009021
heightPerspExp = 1.0015471
sidebar_angle = 0
sidebar_x = 0
sidebar_y = 0

script decompress_height_table
	// thought id need to do delta array since there are duplicate values
	// but this works too i guess, and this takes 0.1ms so i imagine that'd be slower
	change heightPerspFactTable = [ 1.0004050 1.0004240 1.0004179 1.0004170 1.0004170 1.0004359 1.0004259 1.0004250 1.0004250 1.0004441 1.0004380 1.0004359 1.0004359 1.0004549 1.0004460 1.0004450 1.0004450 1.0004640 1.0004569 1.0004559 1.0004559 1.0004749 1.0004659 1.0004649 1.0004649 1.0004840 1.0004770 1.0004759 1.0004759 1.0004950 1.0004859 1.0004849 1.0004849 1.0005040 1.0004970 1.0004959 1.0004959 1.0004959 1.0005059 1.0005059 1.0005059 1.0005059 1.0005170 1.0005159 1.0005159 1.0005159 1.0005260 1.0005260 1.0005260 1.0005260 1.0005370 1.0005360 1.0005360 1.0005360 1.0005471 1.0005460 1.0005460 1.0005460 1.0005569 1.0005559 1.0005559 1.0005559 1.0005670 1.0005659 1.0005659 1.0005659 1.0005770 1.0005759 1.0005759 1.0005759 1.0005870 1.0005859 1.0005859 1.0005859 1.0005970 1.0005959 1.0005959 1.0005959 1.0006070 1.0006059 1.0006059 1.0006059 1.0006170 1.0006160 1.0006160 1.0006160 1.0006270 1.0006260 1.0006260 1.0006260 1.0006371 1.0006360 1.0006360 1.0006360 1.0006471 1.0006460 1.0006460 1.0006460 1.0006570 1.0006559 1.0006559 1.0006750 1.0006670 1.0006659 1.0006659 1.0006850 1.0006770 1.0006759 1.0006759 1.0006950 1.0007020 1.0006859 1.0006859 1.0006970 1.0007050 1.0006959 1.0006959 1.0007070 1.0007060 1.0007060 1.0007060 1.0007170 1.0007160 1.0007160 1.0007160 1.0007271 1.0007260 1.0007260 1.0007451 1.0007520 1.0007360 1.0007360 1.0007471 1.0007460 1.0007460 1.0007460 1.0007570 1.0007559 1.0007559 1.0007559 1.0007670 1.0007659 1.0007659 1.0007850 1.0007850 1.0007759 1.0007759 1.0007870 1.0007859 1.0007859 1.0007859 1.0007970 1.0007960 1.0007960 1.0008070 1.0008060 1.0008060 1.0008060 1.0008171 1.0008160 1.0008160 1.0008160 1.0008421 1.0008260 1.0008260 1.0008371 1.0008360 1.0008360 1.0008360 1.0008620 1.0008460 1.0008460 1.0008570 1.0008559 1.0008559 1.0008559 1.0008750 1.0008659 1.0008659 1.0008770 1.0008759 1.0008941 1.0008870 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0008860 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 1.0009021 ]
	change heightPerspExpTable = [ 1.0010620 1.0010620 1.0010620 1.0010620 1.0010700 1.0010700 1.0010700 1.0010700 1.0010810 1.0010810 1.0010810 1.0010810 1.0010900 1.0010900 1.0010900 1.0010900 1.0011010 1.0011010 1.0011010 1.0011010 1.0011101 1.0011101 1.0011101 1.0011101 1.0011210 1.0011210 1.0011210 1.0011210 1.0011210 1.0011301 1.0011301 1.0011301 1.0011301 1.0011411 1.0011411 1.0011411 1.0011411 1.0011510 1.0011510 1.0011510 1.0011510 1.0011610 1.0011610 1.0011610 1.0011610 1.0011710 1.0011710 1.0011710 1.0011710 1.0011810 1.0011810 1.0011810 1.0011810 1.0011910 1.0011910 1.0011910 1.0011910 1.0012010 1.0012010 1.0012010 1.0012010 1.0012110 1.0012110 1.0012110 1.0012110 1.0012211 1.0012211 1.0012211 1.0012211 1.0012311 1.0012311 1.0012311 1.0012311 1.0012411 1.0012411 1.0012411 1.0012411 1.0012510 1.0012510 1.0012510 1.0012510 1.0012610 1.0012610 1.0012610 1.0012610 1.0012710 1.0012710 1.0012710 1.0012710 1.0012810 1.0012810 1.0012810 1.0012810 1.0012910 1.0012910 1.0012910 1.0012910 1.0013011 1.0013011 1.0013011 1.0013011 1.0013111 1.0013111 1.0013111 1.0013211 1.0013211 1.0013211 1.0013211 1.0013311 1.0013311 1.0013231 1.0013311 1.0013411 1.0013411 1.0013500 1.0013411 1.0013510 1.0013510 1.0013510 1.0013510 1.0013610 1.0013610 1.0013610 1.0013610 1.0013710 1.0013710 1.0013710 1.0013810 1.0013810 1.0013731 1.0013810 1.0013911 1.0013911 1.0014000 1.0013911 1.0014009 1.0014009 1.0014009 1.0014009 1.0014110 1.0014110 1.0014110 1.0014210 1.0014210 1.0014300 1.0014210 1.0014310 1.0014310 1.0014310 1.0014310 1.0014410 1.0014410 1.0014410 1.0014509 1.0014509 1.0014600 1.0014509 1.0014609 1.0014609 1.0014609 1.0014609 1.0014709 1.0014629 1.0014709 1.0014809 1.0014809 1.0014809 1.0014809 1.0014910 1.0014830 1.0014910 1.0015010 1.0015010 1.0015010 1.0015010 1.0015110 1.0015200 1.0015110 1.0015210 1.0015210 1.0015210 1.0015310 1.0015310 1.0015401 1.0015310 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015410 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 1.0015471 ]
endscript

heightPerspFactTable = []
heightPerspExpTable = []
gHighwayTiling = 0.0
highway_playline = 0
highway_height = 0
highway_top_width = 0.0
widthOffsetFactor = 0.0
highway_fade = 0.0
gem_start_scale = 0.0
gem_end_scale = 0.0
gem_star_scale = 0.0
gem_y_just = 0.0
star_y_just = 0.0
fretbar_start_scale = 0.0
whammy_top_width = 0.0
whammy_top_width_open_note = 0.0
whammy_width_offset = 0.0
sidebar_x_offset = 0.0
sidebar_x_scale = 0.0
sidebar_y_offset = 0.0
sidebar_y_scale = 0.0
starpower_fx_scale = 0.0
nowbar_scale_x = 0.0
nowbar_scale_y = 0.0
string_scale_x = 0.0
string_scale_y = 0.0

script generate_pos_table
	tweaks = [
		gHighwayTiling
		highway_playline
		highway_height
		highway_top_width
		widthOffsetFactor
		highway_fade
		gem_start_scale
		gem_end_scale
		gem_star_scale
		gem_y_just
		star_y_just
		fretbar_start_scale
		whammy_top_width
		whammy_top_width_open_note
		whammy_width_offset
		sidebar_x_offset
		sidebar_x_scale
		sidebar_y_offset
		sidebar_y_scale
		starpower_fx_scale
		nowbar_scale_x
		nowbar_scale_y
		string_scale_x
		string_scale_y
	]
	GetArraySize \{tweaks}
	index = 0
	begin
		tweak = (<tweaks>[<index>])
		extendcrc <tweak> ($playercount_text[($current_num_players = 2 | $end_credits = 1)]) out=val
		change globalname=<tweak> newvalue=($<val>)
		Increment \{index}
	repeat <array_size>
	SetAllWhammyValues value = 1.0 Player = 1
	SetAllWhammyValues value = 1.0 Player = 2
	Clamp ($highway_height - 162) min = 0 max = 510
	CastToInteger \{clamped}
	Change heightPerspFact = ($heightPerspFactTable[<clamped>])
	Change heightPerspExp = ($heightPerspExpTable[<clamped>])
	AddParams \{ heightOffsetFactor = $heightPerspFact heightOffsetExp = $heightPerspExp rows = $highway_lines normal_rows = $real_highway_lines height = $highway_height rowHeightNormalizationFactor = 0.0 }
	start_y = ($highway_playline - $highway_height)
	htx = (640.0 - ($highway_top_width / 2.0))
	hbw = ($highway_top_width + ($highway_top_width * $widthOffsetFactor))
	hbx = (640.0 - (<hbw> / 2.0))
	gts = ($highway_top_width / 5.0)
	gbs = (<hbw> / 5.0)
	StringToCharArray \{string = 'grybo'}
	// should use arrays instead of names
	index = 0
	begin
		ExtendCrc #"0xFFFFFFFF" (<char_array>[<index>]+'sx') out = s
		ExtendCrc #"0xFFFFFFFF" (<char_array>[<index>]+'ex') out = e
		xs = (<htx> + (<gts> / 2.0) + (<gts> * <index>))
		xe = (<hbx> + (<gbs> / 2.0) + (<gbs> * <index>))
		AddParam name = <s> value = <xs>
		AddParam name = <e> value = <xe>
		ExtendCrc #"0xFFFFFFFF" (<char_array>[<index>]+'a') out = a
		Atan2 x = $highway_height y = (<xs> - <xe>)
		AddParam name = <a> value = <atan>
		Increment \{index}
	repeat 5
	params = {start_y = <start_y> end_y = ($highway_playline)}
	SetButtonData array = button_models <params> Color = green angle = <ga> start_x = <gsx> end_x = <gex> left_start_x = <osx> left_end_x = <oex> left_angle = <oa>
	SetButtonData array = button_models <params> Color = red angle = <ra> start_x = <rsx> end_x = <rex> left_start_x = <bsx> left_end_x = <bex> left_angle = <ba>
	SetButtonData array = button_models <params> Color = yellow angle = <ya> start_x = <ysx> end_x = <yex> left_start_x = <ysx> left_end_x = <yex> left_angle = <ya>
	SetButtonData array = button_models <params> Color = blue angle = <ba> start_x = <bsx> end_x = <bex> left_start_x = <rsx> left_end_x = <rex> left_angle = <ra>
	SetButtonData array = button_models <params> Color = orange angle = <oa> start_x = <osx> end_x = <oex> left_start_x = <gsx> left_end_x = <gex> left_angle = <ga>
	SetButtonData array = button_up_models Color = green pos_x = <gex> pos_y = ($highway_playline) left_pos_x = <oex>
	SetButtonData array = button_up_models Color = red pos_x = <rex> pos_y = ($highway_playline) left_pos_x = <bex>
	SetButtonData array = button_up_models Color = yellow pos_x = <yex> pos_y = ($highway_playline) left_pos_x = <yex>
	SetButtonData array = button_up_models Color = blue pos_x = <bex> pos_y = ($highway_playline) left_pos_x = <rex>
	SetButtonData array = button_up_models Color = orange pos_x = <oex> pos_y = ($highway_playline) left_pos_x = <gex>
	Change fretbar_end_scale = ($fretbar_start_scale + ($fretbar_start_scale * $widthOffsetFactor))
	Change gem_end_scale = ($gem_start_scale + ($gem_start_scale * $widthOffsetFactor))
	fe = ($highway_playline - $highway_height)
	fs = (<fe> + $highway_fade)
	Change gHighwayStartFade = <fs>
	Change gHighwayEndFade = <fe>
	stx = (640.0 - ($highway_top_width / 2.0))
	sbx = (640.0 - (<hbw> / 2.0))
	Atan2 x = $highway_height y = (<stx> - <sbx>)
	Change sidebar_angle = <atan>
	Change sidebar_x = (<sbx> + ((<sbx> - <stx>) * 0.25) - $sidebar_x_offset)
	Change sidebar_y = ($highway_playline + ($highway_height * 0.25) - ($sidebar_y_offset * 4.2))
	SetArrayElement GlobalArray index = 0 ArrayName = rowHeightNormalizedDistance NewValue = 1.0
	index = 0
	begin
		value = ($rowHeightNormalizedDistance[<index>] * <heightOffsetFactor>)
		MathPow <value> exp = <heightOffsetExp>
		Increment \{index}
		SetArrayElement GlobalArray index = <index> NewValue = <pow> ArrayName = rowHeightNormalizedDistance
		if (<index> < <normal_rows>)
			<rowHeightNormalizationFactor> = (<rowHeightNormalizationFactor> + $rowHeightNormalizedDistance[<index>])
		endif
	repeat <rows>
	<rowHeightNormalizationFactor> = (1.0 / <rowHeightNormalizationFactor>)
	SetArrayElement GlobalArray index = 0 ArrayName = rowHeight NewValue = <start_y>
	SetArrayElement GlobalArray index = 0 ArrayName = time_accum_table NewValue = 0.0
	index = 0
	begin
		value = ($rowHeightNormalizedDistance[<index>] * <rowHeightNormalizationFactor>)
		SetArrayElement GlobalArray index = <index> NewValue = <value> ArrayName = rowHeightNormalizedDistance
		SetArrayElement GlobalArray index = <index> NewValue = <value> ArrayName = gem_time_table512
		value = ($rowHeight[<index>] + (<height> * ($rowHeightNormalizedDistance[<index>])))
		value2 = ($time_accum_table[<index>] + $gem_time_table512[<index>])
		Increment \{index}
		SetArrayElement GlobalArray index = <index> NewValue = <value> ArrayName = rowHeight
		SetArrayElement GlobalArray index = <index> NewValue = <value2> ArrayName = time_accum_table
	repeat <rows>
	SetRowHeightTables
	SetGemConstants
endscript

script generate_move_table \{interval=60 pos_start_orig=0}
	ProfilingStart
	MathPow (<interval>/60.0) exp = 2
	y = 720
	pos_add = -720
	pos_sub = 1.0
	pos_sub_add = (0.0004386 / <pow>)
	intervalth = (1.0/<interval>)
	size = (<interval>*2.5)
	CastToInteger \{size}
	CreateIndexArray <size>
	i = 0
	begin
		<y> = (<y> + (<pos_add> * <intervalth>))
		<pos_add> = (<pos_add> * <pos_sub>)
		<pos_sub> = (<pos_sub> - <pos_sub_add>)
		element = (<y> * 1000.0)
		CastToInteger \{element}
		SetArrayElement arrayname=index_array index=<i> newvalue=<element>
		if (<y> <= <pos_start_orig> || <pos_add> >= -0.002)
			break
		endif
		Increment \{i}
		if (<i> >= <size>)
			break
		endif
	repeat
	ProfilingEnd <...> 'generate_move_table'
	if (<i> >= <size>)
		begin
			printf \{'overshot move table index!!!!!!!!!!!!!'}
		repeat 10
	endif
	//GetArraySize \{index_array}
	//PrintStruct <...>
	return moveTable = <index_array>
endscript



